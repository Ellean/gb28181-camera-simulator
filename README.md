# GB28181 æ‘„åƒå¤´æ¨¡æ‹Ÿå™¨

åŸºäº Docker çš„ GB28181 æ‘„åƒå¤´æ¨¡æ‹Ÿå™¨ï¼Œèƒ½å¤Ÿè®©æ¥å…¥å¹³å°è¯†åˆ«ä¸ºçœŸå®çš„æ‘„åƒå¤´è®¾å¤‡ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **SIP ä¿¡ä»¤å¤„ç†**ï¼šæ”¯æŒ GB/T28181-2011ã€2016ã€2022 æ‰€æœ‰ç‰ˆæœ¬
- âœ… **è®¾å¤‡æ³¨å†Œ**ï¼šå®Œæ•´çš„ Digest è®¤è¯æ”¯æŒ
- âœ… **å¿ƒè·³ä¿æ´»**ï¼šè‡ªåŠ¨å‘é€å¿ƒè·³æ¶ˆæ¯ä¿æŒåœ¨çº¿çŠ¶æ€
- âœ… **è®¾å¤‡ç›®å½•**ï¼šå“åº” Catalog æŸ¥è¯¢ï¼Œè¿”å›è®¾å¤‡é€šé“ä¿¡æ¯
- âœ… **å®æ—¶è§†é¢‘æµ**ï¼šä½¿ç”¨ FFmpeg æ¨é€ H.264 ç¼–ç è§†é¢‘ï¼ˆPS å°è£… + RTP ä¼ è¾“ï¼‰
- âœ… **PTZ äº‘å°æ§åˆ¶**ï¼šè§£æå¹¶å“åº”äº‘å°æ§åˆ¶å‘½ä»¤
- âœ… **è®¾å¤‡ä¿¡æ¯æŸ¥è¯¢**ï¼šè¿”å›è®¾å¤‡åˆ¶é€ å•†ã€å‹å·ã€å›ºä»¶ç‰ˆæœ¬ç­‰ä¿¡æ¯
- âœ… **è®¾å¤‡çŠ¶æ€æŸ¥è¯¢**ï¼šè¿”å›è®¾å¤‡åœ¨çº¿çŠ¶æ€
- âœ… **å¤šè®¾å¤‡æ¨¡æ‹Ÿ**ï¼šæ”¯æŒåŒæ—¶æ¨¡æ‹Ÿå¤šä¸ªè™šæ‹Ÿæ‘„åƒå¤´

### æŠ€æœ¯ç‰¹ç‚¹
- ğŸ Python 3.10+ å®ç°
- ğŸ³ Docker å®¹å™¨åŒ–éƒ¨ç½²
- ğŸ“º FFmpeg åª’ä½“æµæ¨é€
- ğŸ”§ å®Œå…¨å¯é…ç½®ï¼ˆ.env + YAMLï¼‰
- ğŸ“ è¯¦ç»†æ—¥å¿—è¾“å‡º

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker å’Œ Docker Compose
- GB28181 å¹³å°æœåŠ¡å™¨ï¼ˆç”¨äºæ¥å…¥æµ‹è¯•ï¼‰

### å¿«é€ŸéªŒè¯é…ç½®

ä½¿ç”¨é…ç½®éªŒè¯è„šæœ¬æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼š
```bash
python3 scripts/validate_config.py
```

è¯¥è„šæœ¬ä¼šæ£€æŸ¥ï¼š
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… è®¾å¤‡é…ç½®æ–‡ä»¶
- âœ… æµ‹è¯•è§†é¢‘æ–‡ä»¶

### å®‰è£…æ­¥éª¤

1. **å…‹éš†ä»“åº“**
```bash
git clone https://github.com/Ellean/gb28181-camera-simulator.git
cd gb28181-camera-simulator
```

2. **å‡†å¤‡é…ç½®æ–‡ä»¶**
```bash
cp .env.example .env
```

3. **ç¼–è¾‘é…ç½®æ–‡ä»¶**

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½® SIP æœåŠ¡å™¨ä¿¡æ¯ï¼š
```env
SIP_SERVER_IP=192.168.1.100        # SIP æœåŠ¡å™¨ IP
SIP_SERVER_PORT=5060               # SIP æœåŠ¡å™¨ç«¯å£
SIP_SERVER_ID=34020000002000000001 # å¹³å°/æœåŠ¡å™¨ ID
SIP_DOMAIN=3402000000              # SIP åŸŸ
```

4. **å‡†å¤‡æµ‹è¯•è§†é¢‘**

å°†æµ‹è¯•è§†é¢‘æ–‡ä»¶æ”¾ç½®åˆ° `media/` ç›®å½•ï¼š
```bash
# å°†ä½ çš„æµ‹è¯•è§†é¢‘å¤åˆ¶åˆ° media ç›®å½•
cp /path/to/your/video.mp4 media/sample.mp4
```

æˆ–ä½¿ç”¨æä¾›çš„è„šæœ¬ç”Ÿæˆæµ‹è¯•è§†é¢‘ï¼š
```bash
# éœ€è¦å…ˆå®‰è£… FFmpeg
sudo apt-get install ffmpeg  # Ubuntu/Debian
# æˆ–
brew install ffmpeg  # macOS

# è¿è¡Œè„šæœ¬ç”Ÿæˆæµ‹è¯•è§†é¢‘
./scripts/generate_test_video.sh
```

æ‰‹åŠ¨ç”Ÿæˆï¼š
```bash
ffmpeg -f lavfi -i testsrc=duration=60:size=1280x720:rate=25 \
  -vcodec libx264 -pix_fmt yuv420p media/sample.mp4
```

5. **é…ç½®è®¾å¤‡ä¿¡æ¯**

ç¼–è¾‘ `config/devices.yaml` é…ç½®è™šæ‹Ÿæ‘„åƒå¤´è®¾å¤‡ï¼š
```yaml
devices:
  - device_id: "34020000001320000001"
    name: "æ¨¡æ‹Ÿæ‘„åƒå¤´-1"
    manufacturer: "SimCamera"
    model: "SC-2000"
    firmware: "V1.0.0"
    channels:
      - channel_id: "34020000001320000001"
        name: "ä¸»ç æµ"
        ptz_enabled: true
    sip_user: "34020000001320000001"
    sip_password: "12345678"
```

6. **å¯åŠ¨æ¨¡æ‹Ÿå™¨**
```bash
docker-compose up -d
```

7. **æŸ¥çœ‹æ—¥å¿—**
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
tail -f logs/simulator.log
```

## ğŸ“‹ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½® (.env)

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `SIP_SERVER_IP` | SIP æœåŠ¡å™¨ IP åœ°å€ | `192.168.1.100` |
| `SIP_SERVER_PORT` | SIP æœåŠ¡å™¨ç«¯å£ | `5060` |
| `SIP_SERVER_ID` | å¹³å°/æœåŠ¡å™¨è®¾å¤‡ ID | `34020000002000000001` |
| `SIP_DOMAIN` | SIP åŸŸ | `3402000000` |
| `DEVICES_CONFIG` | è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ | `config/devices.yaml` |
| `VIDEO_FILE` | æµ‹è¯•è§†é¢‘æ–‡ä»¶è·¯å¾„ | `media/sample.mp4` |
| `RTP_PORT_START` | RTP ç«¯å£èŒƒå›´èµ·å§‹ | `30000` |
| `RTP_PORT_END` | RTP ç«¯å£èŒƒå›´ç»“æŸ | `30100` |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` / `DEBUG` |
| `LOG_DIR` | æ—¥å¿—ç›®å½• | `logs` |

### è®¾å¤‡é…ç½® (config/devices.yaml)

```yaml
devices:
  - device_id: "34020000001320000001"      # è®¾å¤‡ IDï¼ˆ20ä½å›½æ ‡ç¼–ç ï¼‰
    name: "æ¨¡æ‹Ÿæ‘„åƒå¤´-1"                    # è®¾å¤‡åç§°
    manufacturer: "SimCamera"              # åˆ¶é€ å•†
    model: "SC-2000"                       # å‹å·
    firmware: "V1.0.0"                     # å›ºä»¶ç‰ˆæœ¬
    channels:                              # é€šé“åˆ—è¡¨
      - channel_id: "34020000001320000001" # é€šé“ ID
        name: "ä¸»ç æµ"                      # é€šé“åç§°
        ptz_enabled: true                  # æ˜¯å¦æ”¯æŒ PTZ
    sip_user: "34020000001320000001"       # SIP ç”¨æˆ·å
    sip_password: "12345678"               # SIP å¯†ç 
```

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### å•è®¾å¤‡æ¨¡æ‹Ÿ

æœ€ç®€é…ç½® `config/devices.yaml`ï¼š
```yaml
devices:
  - device_id: "34020000001320000001"
    name: "æµ‹è¯•æ‘„åƒå¤´"
    sip_user: "34020000001320000001"
    sip_password: "12345678"
    channels:
      - channel_id: "34020000001320000001"
        name: "ä¸»ç æµ"
        ptz_enabled: true
```

### å¤šè®¾å¤‡æ¨¡æ‹Ÿ

é…ç½®å¤šä¸ªè®¾å¤‡ï¼š
```yaml
devices:
  - device_id: "34020000001320000001"
    name: "æ‘„åƒå¤´-1"
    sip_user: "34020000001320000001"
    sip_password: "12345678"
    channels:
      - channel_id: "34020000001320000001"
        name: "ä¸»ç æµ"
        ptz_enabled: true
  
  - device_id: "34020000001320000002"
    name: "æ‘„åƒå¤´-2"
    sip_user: "34020000001320000002"
    sip_password: "12345678"
    channels:
      - channel_id: "34020000001320000002"
        name: "ä¸»ç æµ"
        ptz_enabled: true
```

### æœ¬åœ°å¼€å‘è¿è¡Œ

ä¸ä½¿ç”¨ Docker è¿è¡Œï¼š
```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£… FFmpeg
# Ubuntu/Debian:
sudo apt-get install ffmpeg

# macOS:
brew install ffmpeg

# è®¾ç½®ç¯å¢ƒå˜é‡
export PYTHONPATH=./src

# è¿è¡Œæ¨¡æ‹Ÿå™¨
python src/main.py
```

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. è®¾å¤‡æ— æ³•æ³¨å†Œåˆ°å¹³å°

**æ£€æŸ¥é¡¹ï¼š**
- SIP æœåŠ¡å™¨ IP å’Œç«¯å£æ˜¯å¦æ­£ç¡®
- è®¾å¤‡ ID å’Œå¯†ç æ˜¯å¦ä¸å¹³å°é…ç½®ä¸€è‡´
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- æŸ¥çœ‹æ—¥å¿— `logs/simulator.log` è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### 2. å¹³å°æ— æ³•æ‹‰å–è§†é¢‘æµ

**æ£€æŸ¥é¡¹ï¼š**
- è§†é¢‘æ–‡ä»¶ `media/sample.mp4` æ˜¯å¦å­˜åœ¨
- FFmpeg æ˜¯å¦æ­£ç¡®å®‰è£…
- RTP ç«¯å£èŒƒå›´ï¼ˆ30000-30100ï¼‰æ˜¯å¦è¢«å ç”¨
- ç½‘ç»œé˜²ç«å¢™æ˜¯å¦å…è®¸ UDP æµé‡

### 3. Docker å®¹å™¨ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼ï¼ˆæ¨èï¼‰
# docker-compose.yml ä¸­å·²é…ç½® network_mode: host

# æˆ–è€…ä½¿ç”¨ bridge æ¨¡å¼å¹¶æ˜ å°„ç«¯å£
# éœ€è¦ä¿®æ”¹ docker-compose.ymlï¼š
# ports:
#   - "5060:5060/udp"
#   - "30000-30100:30000-30100/udp"
```

### 4. æŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯

ä¿®æ”¹ `.env` æ–‡ä»¶ï¼š
```env
LOG_LEVEL=DEBUG
```

ç„¶åé‡å¯å®¹å™¨ï¼š
```bash
docker-compose restart
```

### 5. æ¸…ç†å’Œé‡å¯

```bash
# åœæ­¢å¹¶ç§»é™¤å®¹å™¨
docker-compose down

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æ¸…ç†æ—¥å¿—
rm -rf logs/*.log
```

## ğŸ“Š æ”¯æŒçš„ GB28181 åŠŸèƒ½

| åŠŸèƒ½ | æ”¯æŒçŠ¶æ€ | è¯´æ˜ |
|------|---------|------|
| SIP REGISTER | âœ… | è®¾å¤‡æ³¨å†Œ |
| Digest è®¤è¯ | âœ… | MD5 æ‘˜è¦è®¤è¯ |
| Keepalive | âœ… | å¿ƒè·³ä¿æ´» |
| Catalog æŸ¥è¯¢ | âœ… | è®¾å¤‡ç›®å½•æŸ¥è¯¢ |
| DeviceInfo æŸ¥è¯¢ | âœ… | è®¾å¤‡ä¿¡æ¯æŸ¥è¯¢ |
| DeviceStatus æŸ¥è¯¢ | âœ… | è®¾å¤‡çŠ¶æ€æŸ¥è¯¢ |
| å®æ—¶è§†é¢‘ INVITE | âœ… | å®æ—¶è§†é¢‘é‚€è¯· |
| RTP è§†é¢‘æ¨é€ | âœ… | PS å°è£… H.264 |
| PTZ æ§åˆ¶ | âœ… | äº‘å°æ§åˆ¶ï¼ˆæ¨¡æ‹Ÿå“åº”ï¼‰|
| TCP ä¼ è¾“ | âœ… | æ”¯æŒ TCP æ¨¡å¼ |
| UDP ä¼ è¾“ | âœ… | æ”¯æŒ UDP æ¨¡å¼ |
| å½•åƒæŸ¥è¯¢ | âŒ | ä¸æ”¯æŒï¼ˆNVR åŠŸèƒ½ï¼‰|
| å½•åƒå›æ”¾ | âŒ | ä¸æ”¯æŒï¼ˆNVR åŠŸèƒ½ï¼‰|

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GB28181 Platform                  â”‚
â”‚         (SIP Server + Media Client)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ SIP/UDP 5060
                 â”‚ RTP/UDP 30000-30100
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       GB28181 Camera Simulator              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         SIP Client (main.py)         â”‚   â”‚
â”‚  â”‚  - Device Registration               â”‚   â”‚
â”‚  â”‚  - Keepalive Loop                    â”‚   â”‚
â”‚  â”‚  - Message Handler                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚              â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Catalog Handler â”‚  â”‚  PTZ Handler   â”‚    â”‚
â”‚  â”‚ - Device List   â”‚  â”‚  - Commands    â”‚    â”‚
â”‚  â”‚ - Device Info   â”‚  â”‚  - Control     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Media Server (FFmpeg)           â”‚   â”‚
â”‚  â”‚  - Video Streaming                   â”‚   â”‚
â”‚  â”‚  - PS Encapsulation                  â”‚   â”‚
â”‚  â”‚  - RTP Transport                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ å¼€å‘è¯´æ˜

### é¡¹ç›®ç»“æ„

```
gb28181-camera-simulator/
â”œâ”€â”€ Dockerfile                  # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml          # Docker Compose é…ç½®
â”œâ”€â”€ .env.example               # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                 # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ requirements.txt           # Python ä¾èµ–
â”œâ”€â”€ README.md                  # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ config/
â”‚   â””â”€â”€ devices.yaml          # è®¾å¤‡é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate_test_video.sh # ç”Ÿæˆæµ‹è¯•è§†é¢‘è„šæœ¬
â”‚   â””â”€â”€ validate_config.py    # é…ç½®éªŒè¯è„šæœ¬
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py               # ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ sip_client.py         # SIP ä¿¡ä»¤å¤„ç†
â”‚   â”œâ”€â”€ media_server.py       # åª’ä½“æµæ¨é€
â”‚   â”œâ”€â”€ ptz_handler.py        # PTZ æ§åˆ¶
â”‚   â”œâ”€â”€ catalog_handler.py    # ç›®å½•æŸ¥è¯¢
â”‚   â”œâ”€â”€ xml_builder.py        # XML æ¶ˆæ¯æ„å»º
â”‚   â”œâ”€â”€ gb28181_protocol.py   # åè®®å¸¸é‡
â”‚   â””â”€â”€ utils.py              # å·¥å…·å‡½æ•°
â”œâ”€â”€ media/
â”‚   â”œâ”€â”€ .gitkeep
â”‚   â””â”€â”€ sample.mp4            # æµ‹è¯•è§†é¢‘ï¼ˆè‡ªè¡Œæ·»åŠ ï¼‰
â””â”€â”€ logs/                     # æ—¥å¿—ç›®å½•
```

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ‰©å±• XML æ¶ˆæ¯ç±»å‹**ï¼šç¼–è¾‘ `src/xml_builder.py`
2. **æ·»åŠ æ–°çš„å‘½ä»¤å¤„ç†**ï¼šæ‰©å±• `src/catalog_handler.py` æˆ– `src/ptz_handler.py`
3. **ä¿®æ”¹ SIP è¡Œä¸º**ï¼šç¼–è¾‘ `src/sip_client.py`

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ”— ç›¸å…³èµ„æº

- [GB/T 28181-2016 æ ‡å‡†æ–‡æ¡£](http://www.gab.gov.cn/)
- [SIP Protocol RFC 3261](https://tools.ietf.org/html/rfc3261)
- [FFmpeg å®˜æ–¹æ–‡æ¡£](https://ffmpeg.org/documentation.html)

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ GitHub Issues è”ç³»ã€‚

---

**âš ï¸ æ³¨æ„**: æœ¬é¡¹ç›®ä»…ç”¨äºæµ‹è¯•å’Œå­¦ä¹ ç›®çš„ï¼Œè¯·å‹¿ç”¨äºéæ³•ç”¨é€”ã€‚
